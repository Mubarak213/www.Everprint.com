<!DOCTYPE html>
<html>
<head>
  <title>Pay & Print</title>

  <!-- Supabase Client -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>

  <!-- Razorpay Checkout -->
  <script src="https://checkout.razorpay.com/v1/checkout.js"></script>

  <!-- PDF.js for page count -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
  <script>
    const pdfjsLib = window['pdfjs-dist/build/pdf'];
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';
  </script>
</head>

<body>
  <h2>Upload & Print PDF</h2>

  <form id="uploadForm">
    <input type="file" id="file" accept="application/pdf" required />
    <button type="submit">Upload & Print</button>
  </form>

  <p id="status"></p>

  <script>
    // üîß CONFIG
    const SUPABASE_URL = 'https://lblruuemrevxqpohhxeq.supabase.co';
    const SUPABASE_PUBLIC_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxibHJ1dWVtcmV2eHFwb2hoeGVxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYwMzM3MDUsImV4cCI6MjA3MTYwOTcwNX0.5h3JPaMOcW3eMcFv_jelNQgmPwJ0xpV5VoB2T6_UMwg'; // anon key
    const RAZORPAY_KEY = 'rzp_test_R97CT8W0dJjd7g'; // Replace with your test/live Razorpay key
    const RATE_PER_PAGE = 10; // ‚Çπ per page

    // üîå Supabase client
    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_PUBLIC_KEY);

    document.getElementById('uploadForm').addEventListener('submit', async function (e) {
      e.preventDefault();
      const file = document.getElementById('file').files[0];
      const status = document.getElementById('status');

      if (!file || file.type !== 'application/pdf') {
        alert('Select a valid PDF file.');
        return;
      }

      status.textContent = 'Reading PDF...';

      const reader = new FileReader();
      reader.onload = async () => {
        try {
          const pdf = await pdfjsLib.getDocument({ data: new Uint8Array(reader.result) }).promise;
          const pages = pdf.numPages;
          const amount = pages * RATE_PER_PAGE * 100; // in paise

          // ‚úÖ Razorpay Payment
          const options = {
            key: RAZORPAY_KEY,
            amount: amount,
            currency: "INR",
            name: "Ever Printer",
            description: `${pages} pages to print`,
            handler: async function (response) {
              console.log("‚úÖ Payment ID:", response.razorpay_payment_id);
              status.textContent = "Uploading file...";

              const path = `printjobs/${Date.now()}_${file.name}`;
              const { error: uploadError } = await supabaseClient.storage
                .from('print-jobs')
                .upload(path, file, {
                  contentType: 'application/pdf',
                  upsert: true
                });

              if (uploadError) {
                console.error("‚ùå Upload failed:", uploadError.message);
                status.textContent = "Upload failed: " + uploadError.message;
                return;
              }

              // ‚úÖ Insert into Supabase DB with payment info
              const { data: insertData, error: insertError } = await supabaseClient
                .from('print_queue')
                .insert([{
                  file_path: path,
                  payment_id: response.razorpay_payment_id,
                  paid_amount: amount / 100  // convert from paise to INR
                }]);

              if (insertError) {
                console.error("‚ùå DB Insert failed:", insertError.message);
                status.textContent = "Database insert failed: " + insertError.message;
                return;
              }

              status.textContent = `‚úÖ Uploaded and queued for printing (${pages} pages).`;
              console.log("üìù Inserted record:", insertData);
            },
            prefill: {
              name: "",
              email: "",
              contact: ""
            },
            theme: {
              color: "#3399cc"
            }
          };

          const rzp = new Razorpay(options);
          rzp.open();

        } catch (err) {
          console.error("‚ùå PDF error:", err);
          status.textContent = "Failed to process PDF.";
        }
      };

      reader.readAsArrayBuffer(file);
    });
  </script>
</body>
</html>
